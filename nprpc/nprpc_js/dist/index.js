!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("nprpc_runtime",[],t):"object"==typeof exports?exports.nprpc_runtime=t():e.nprpc_runtime=t()}("undefined"!=typeof self?self:this,(()=>(()=>{"use strict";var e={d:(t,s)=>{for(var r in s)e.o(s,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:s[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{Connection:()=>Ce,DebugLevel:()=>xe,EndPoint:()=>Ve,EndPointType:()=>ye,Exception:()=>le,ExceptionBadAccess:()=>Fe,ExceptionBadInput:()=>Me,ExceptionCommFailure:()=>me,ExceptionObjectNotExist:()=>Ie,ExceptionTimeout:()=>je,ExceptionUnknownFunctionIndex:()=>Ee,ExceptionUnknownMessageId:()=>Oe,ExceptionUnsecuredObject:()=>Ae,Flat:()=>s,FlatBuffer:()=>ue,Flat_nprpc_base:()=>we,Flat_nprpc_nameserver:()=>ft,MyPromise:()=>pe,Nameserver:()=>it,ObjectProxy:()=>He,ObjectServant:()=>$e,Poa:()=>We,ReferenceList:()=>Ge,Rpc:()=>Ne,_INameserver_Servant:()=>nt,create_object_from_flat:()=>Ze,detail:()=>Ue,get_nameserver:()=>ot,handle_standart_reply:()=>Ke,impl:()=>De,init:()=>et,ip4tostr:()=>be,make_ref:()=>de,make_simple_answer:()=>Je,narrow:()=>Ye,oid_assign_from_ts:()=>Xe,oid_create_from_flat:()=>Qe,rpc:()=>ke,set_debug_level:()=>tt,sip4_to_u32:()=>he});var s={};e.r(s),e.d(s,{Array_Direct1_f32:()=>C,Array_Direct1_f64:()=>N,Array_Direct1_i16:()=>k,Array_Direct1_i32:()=>T,Array_Direct1_i64:()=>q,Array_Direct1_i8:()=>z,Array_Direct1_u16:()=>B,Array_Direct1_u32:()=>S,Array_Direct1_u64:()=>V,Array_Direct1_u8:()=>M,Array_Direct2:()=>P,Flat:()=>r,Optional_Direct1_Vector_boolean:()=>se,Optional_Direct1_Vector_f32:()=>ae,Optional_Direct1_Vector_f64:()=>_e,Optional_Direct1_Vector_i16:()=>ne,Optional_Direct1_Vector_i32:()=>oe,Optional_Direct1_Vector_i8:()=>re,Optional_Direct1_Vector_u16:()=>ie,Optional_Direct1_Vector_u32:()=>fe,Optional_Direct1_Vector_u8:()=>te,Optional_Direct1_boolean:()=>H,Optional_Direct1_f32:()=>Z,Optional_Direct1_f64:()=>ee,Optional_Direct1_i16:()=>G,Optional_Direct1_i32:()=>Q,Optional_Direct1_i64:()=>Y,Optional_Direct1_i8:()=>$,Optional_Direct1_u16:()=>J,Optional_Direct1_u32:()=>K,Optional_Direct1_u64:()=>X,Optional_Direct1_u8:()=>W,Optional_Direct2:()=>ce,String_Direct1:()=>R,Vector_Direct1_f32:()=>O,Vector_Direct1_f64:()=>A,Vector_Direct1_i16:()=>U,Vector_Direct1_i32:()=>j,Vector_Direct1_i64:()=>E,Vector_Direct1_i8:()=>x,Vector_Direct1_u16:()=>y,Vector_Direct1_u32:()=>D,Vector_Direct1_u64:()=>I,Vector_Direct1_u8:()=>w,Vector_Direct2:()=>F,_alloc:()=>i,_alloc1:()=>n});class r{constructor(e,t){this.buffer=e,this.offset=t}}function i(e,t,s,r,i){if(0==s)return e.dv.setUint32(t,0,!0),e.dv.setUint32(t+4,0,!0),0;let n=e.offset%i,f=n?e.offset+(i-n):e.offset;{let t=s*r+(f-e.offset);e.prepare(t),e.commit(t)}return e.dv.setUint32(t,f-t,!0),e.dv.setUint32(t+4,s,!0),f}function n(e,t,s,r){let i=e.offset%r,n=i?e.offset+(r-i):e.offset;{let t=s+(n-e.offset);e.prepare(t),e.commit(t)}return e.dv.setUint32(t,n-t,!0),n}class f extends r{get elements_offset(){return this.offset+this.buffer.dv.getUint32(this.offset,!0)}get elements_size(){return this.buffer.dv.getUint32(this.offset+4,!0)}}class o extends r{constructor(e,t,s){super(e,t),this.buffer=e,this.offset=t,this.size=s}get elements_offset(){return this.offset}get elements_size(){return this.size}}function a(e){return class extends e{[Symbol.iterator](){let e=this;const t=e.elements_size;let s=0;return{next:()=>s<t?{value:e.at(s++),done:!1}:{value:t,done:!0}}}}}function _(e){return class extends e{[Symbol.iterator](){let e=this;const t=e.elements_size;let s=0;return{next:()=>s<t?{value:e.at(s++),done:!1}:{value:t,done:!0}}}}}function c(e){return class extends e{at(e){return this.buffer.dv.getUint8(this.elements_offset+e)}set(e,t){this.buffer.dv.setUint8(this.elements_offset+e,t)}copy_from_ts_array(e){new Uint8Array(this.buffer.array_buffer,this.elements_offset,this.elements_size).set(e)}get array(){return Array.from(new Uint8Array(this.buffer.array_buffer,this.elements_offset,this.elements_size))}get array_buffer(){let e=this.elements_offset;return this.buffer.array_buffer.slice(e,e+this.elements_size)}get data_view(){return new DataView(this.buffer.array_buffer,this.elements_offset)}}}function u(e){return class extends e{at(e){return this.buffer.dv.getInt8(this.elements_offset+e)}set(e,t){this.buffer.dv.setInt8(this.elements_offset+e,t)}copy_from_ts_array(e){new Int8Array(this.buffer.array_buffer,this.elements_offset,this.elements_size).set(e)}get array(){return Array.from(new Int8Array(this.buffer.array_buffer,this.elements_offset,this.elements_size))}}}function l(e){return class extends e{at(e){return this.buffer.dv.getUint16(this.elements_offset+2*e,!0)}set(e,t){this.buffer.dv.setUint16(this.elements_offset+2*e,t,!0)}copy_from_ts_array(e){let t=this.elements_offset;for(let s of e)this.buffer.dv.setUint16(t,s,!0),t+=2}get array(){return Array.from(new Uint16Array(this.buffer.array_buffer,this.elements_offset,this.elements_size))}}}function d(e){return class extends e{at(e){return this.buffer.dv.getInt16(this.elements_offset+2*e,!0)}set(e,t){this.buffer.dv.setInt16(this.elements_offset+2*e,t,!0)}copy_from_ts_array(e){let t=this.elements_offset;for(let s of e)this.buffer.dv.setInt16(t,s,!0),t+=2}get array(){return Array.from(new Int16Array(this.buffer.array_buffer,this.elements_offset,this.elements_size))}}}function h(e){return class extends e{at(e){return this.buffer.dv.getUint32(this.elements_offset+4*e,!0)}set(e,t){this.buffer.dv.setUint32(this.elements_offset+4*e,t,!0)}copy_from_ts_array(e){let t=this.elements_offset;for(let s of e)this.buffer.dv.setUint32(t,s,!0),t+=4}get array(){return Array.from(new Uint32Array(this.buffer.array_buffer,this.elements_offset,this.elements_size))}}}function b(e){return class extends e{at(e){return this.buffer.dv.getInt32(this.elements_offset+4*e,!0)}set(e,t){this.buffer.dv.setInt32(this.elements_offset+4*e,t,!0)}copy_from_ts_array(e){let t=this.elements_offset;for(let s of e)this.buffer.dv.setInt32(t,s,!0),t+=4}get array(){return Array.from(new Int32Array(this.buffer.array_buffer,this.elements_offset,this.elements_size))}}}function p(e){return class extends e{at(e){return this.buffer.dv.getBigUint64(this.elements_offset+8*e,!0)}set(e,t){this.buffer.dv.setBigUint64(this.elements_offset+8*e,t,!0)}copy_from_ts_array(e){let t=this.elements_offset;for(let s of e)this.buffer.dv.setBigUint64(t,s,!0),t+=8}get array(){return Array.from(new BigUint64Array(this.buffer.array_buffer,this.elements_offset,this.elements_size))}}}function g(e){return class extends e{at(e){return this.buffer.dv.getBigInt64(this.elements_offset+8*e,!0)}set(e,t){this.buffer.dv.setBigInt64(this.elements_offset+8*e,t,!0)}copy_from_ts_array(e){let t=this.elements_offset;for(let s of e)this.buffer.dv.setBigInt64(t,s,!0),t+=8}get array(){return Array.from(new BigInt64Array(this.buffer.array_buffer,this.elements_offset,this.elements_size))}}}function v(e){return class extends e{at(e){return this.buffer.dv.getFloat32(this.elements_offset+4*e,!0)}set(e,t){this.buffer.dv.setFloat32(this.elements_offset+4*e,t,!0)}copy_from_ts_array(e){let t=this.elements_offset;for(let s of e)this.buffer.dv.setFloat32(t,s,!0),t+=4}get array(){return Array.from(new Float32Array(this.buffer.array_buffer,this.elements_offset,this.elements_size))}}}function m(e){return class extends e{at(e){return this.buffer.dv.getFloat64(this.elements_offset+8*e,!0)}set(e,t){this.buffer.dv.setFloat64(this.elements_offset+8*e,t,!0)}copy_from_ts_array(e){let t=this.elements_offset;for(let s of e)this.buffer.dv.setFloat64(t,s,!0),t+=8}get array(){return Array.from(new Float64Array(this.buffer.array_buffer,this.elements_offset,this.elements_size))}}}const w=a(c(f)),x=a(u(f)),y=a(l(f)),U=a(d(f)),D=a(h(f)),j=a(b(f)),I=_(p(f)),E=_(g(f)),O=a(v(f)),A=a(m(f));class F extends f{constructor(e,t,s,r){super(e,t),this.element_size=s,this.flat_struct_constructor=r}*[Symbol.iterator](){let e=this.elements_size;for(let t=0;t<e;++t)yield new this.flat_struct_constructor(this.buffer,this.elements_offset+this.element_size*t)}}const M=a(c(o)),z=a(u(o)),B=a(l(o)),k=a(d(o)),S=a(h(o)),T=a(b(o)),V=_(p(o)),q=_(g(o)),C=a(v(o)),N=a(m(o));class P extends o{constructor(e,t,s,r,i){super(e,t,i),this.element_size=s,this.flat_struct_constructor=r}*[Symbol.iterator](){let e=this.elements_size;for(let t=0;t<e;++t)yield new this.flat_struct_constructor(this.buffer,this.elements_offset+this.element_size*t)}}class R extends(a(c(f))){assign(e){let t=(new TextEncoder).encode(e),s=i(this.buffer,this.offset,t.length,1,1);new Uint8Array(this.buffer.array_buffer,s).set(t)}}class L extends r{constructor(e,t,s,r){super(e,t),this.ut_size=s,this.ut_align=r}get value_offset(){return this.offset+this.buffer.dv.getUint32(this.offset,!0)}alloc(){n(this.buffer,this.offset,this.ut_size,this.ut_align)}get has_value(){return 0!==this.buffer.dv.getUint32(this.offset,!0)}set_nullopt(){this.buffer.dv.setUint32(this.offset,0,!0)}}class W extends L{get value(){return this.buffer.dv.getUint8(this.value_offset)}set value(e){this.buffer.dv.setUint8(this.value_offset,e)}}class H extends L{get value(){return 1===this.buffer.dv.getUint8(this.value_offset)}set value(e){this.buffer.dv.setUint8(this.value_offset,!0===e?1:0)}}class $ extends L{get value(){return this.buffer.dv.getInt8(this.value_offset)}set value(e){this.buffer.dv.setInt8(this.value_offset,e)}}class J extends L{get value(){return this.buffer.dv.getUint16(this.value_offset,!0)}set value(e){this.buffer.dv.setUint16(this.value_offset,e,!0)}}class G extends L{get value(){return this.buffer.dv.getInt16(this.value_offset,!0)}set value(e){this.buffer.dv.setInt16(this.value_offset,e,!0)}}class K extends L{get value(){return this.buffer.dv.getUint32(this.value_offset,!0)}set value(e){this.buffer.dv.setUint32(this.value_offset,e,!0)}}class Q extends L{get value(){return this.buffer.dv.getInt32(this.value_offset,!0)}set value(e){this.buffer.dv.setInt32(this.value_offset,e,!0)}}class X extends L{get value(){return this.buffer.dv.getBigUint64(this.value_offset,!0)}set value(e){this.buffer.dv.setBigUint64(this.value_offset,e,!0)}}class Y extends L{get value(){return this.buffer.dv.getBigInt64(this.value_offset,!0)}set value(e){this.buffer.dv.setBigInt64(this.value_offset,e,!0)}}class Z extends L{get value(){return this.buffer.dv.getFloat32(this.value_offset,!0)}set value(e){this.buffer.dv.setFloat32(this.value_offset,e,!0)}}class ee extends L{get value(){return this.buffer.dv.getFloat64(this.value_offset,!0)}set value(e){this.buffer.dv.setFloat64(this.value_offset,e,!0)}}class te extends L{value(e){i(this.buffer,this.value_offset,e,1,1)}value_d(){return new w(this.buffer,this.value_offset)}}const se=te;class re extends L{value(e){i(this.buffer,this.value_offset,e,1,1)}value_d(){return new x(this.buffer,this.value_offset)}}class ie extends L{value(e){i(this.buffer,this.value_offset,e,2,2)}value_d(){return new y(this.buffer,this.value_offset)}}class ne extends L{value(e){i(this.buffer,this.value_offset,e,2,2)}value_d(){return new U(this.buffer,this.value_offset)}}class fe extends L{value(e){i(this.buffer,this.value_offset,e,4,4)}value_d(){return new D(this.buffer,this.value_offset)}}class oe extends L{value(e){i(this.buffer,this.value_offset,e,4,4)}value_d(){return new j(this.buffer,this.value_offset)}}class ae extends L{value(e){i(this.buffer,this.value_offset,e,4,4)}value_d(){return new O(this.buffer,this.value_offset)}}class _e extends L{value(e){i(this.buffer,this.value_offset,e,8,8)}value_d(){return new A(this.buffer,this.value_offset)}}class ce extends L{constructor(e,t,s,r,i){super(e,t,s,r),this.flat_struct_constructor=i}get value(){return new this.flat_struct_constructor(this.buffer,this.value_offset)}}class ue{static from_array_buffer(e){let t=new ue;return t.array_buffer=e,t.size_=t.capacity=e.byteLength,t.dv=new DataView(t.array_buffer),t}static create(e=512){let t=new ue;return t.capacity=e,t.size_=0,t.array_buffer=new ArrayBuffer(e),t.dv=new DataView(t.array_buffer),t}prepare(e){if(this.size_+e>this.capacity){this.capacity=Math.max(2*this.capacity,this.capacity+e);let t=new ArrayBuffer(this.capacity);new Uint8Array(t).set(new Uint8Array(this.array_buffer)),this.array_buffer=t,this.dv=new DataView(this.array_buffer)}}consume(e){this.size_-=e}commit(e){this.size_+=e}get offset(){return this.size_}get size(){return this.size_}write_len(e){this.dv.setUint32(0,e,!0)}write_msg_id(e){this.dv.setUint32(4,e,!0)}read_msg_id(){return this.dv.getUint32(4,!0)}write_msg_type(e){this.dv.setUint32(8,e,!0)}read_msg_type(){return this.dv.getUint32(8,!0)}read_exception_number(){return this.dv.getUint32(16,!0)}write_request_id(e){this.dv.setUint32(12,e,!0)}read_request_id(){return this.dv.getUint32(12,!0)}get writable_view(){return new DataView(this.array_buffer,0,this.size)}set_buffer(e){this.array_buffer=e,this.size_=this.capacity=e.byteLength,this.dv=new DataView(this.array_buffer)}dump(){let e=new String;new Uint8Array(this.array_buffer,0,this.size).forEach((t=>e+=t.toString(16)+" ")),console.log(e)}}class le extends Error{constructor(e){super(e)}}function de(){return{value:void 0}}const he=e=>{let t=/(\d+)\.(\d+)\.(\d+)\.(\d+)/gi.exec(e);if(5!=t.length)throw"ip address is incorrect";return Number(t[1])<<24|Number(t[2])<<16|Number(t[3])<<8|Number(t[4])},be=e=>(e>>24&255)+"."+(e>>16&255)+"."+(e>>8&255)+"."+(255&e);class pe{constructor(){this.actual_promise_=new Promise(((e,t)=>{this.resolve_=t=>{e(t)},this.reject_=e=>{t(e)}}))}get $(){return this.actual_promise_}set_promise(e){this.resolve_(e)}set_exception(e){this.reject_(e)}}const ge=new TextEncoder,ve=new TextDecoder;class me extends le{constructor(e){super("ExceptionCommFailure"),this.what=e}}var we,xe,ye,Ue,De;!function(e){e.ExceptionCommFailure_Direct=class extends r{get __ex_id(){return this.buffer.dv.getUint32(this.offset+0,!0)}set __ex_id(e){this.buffer.dv.setUint32(this.offset+0,e,!0)}get what(){const e=this.offset+4,t=this.buffer.dv.getUint32(e+4,!0);return t>0?ve.decode(new DataView(this.buffer.array_buffer,e+this.buffer.dv.getUint32(e,!0),t)):""}set what(e){const t=ge.encode(e),s=i(this.buffer,this.offset+4,t.length,1,1);new Uint8Array(this.buffer.array_buffer,s).set(t)}}}(we||(we={}));class je extends le{constructor(){super("ExceptionTimeout")}}!function(e){e.ExceptionTimeout_Direct=class extends r{get __ex_id(){return this.buffer.dv.getUint32(this.offset+0,!0)}set __ex_id(e){this.buffer.dv.setUint32(this.offset+0,e,!0)}}}(we||(we={}));class Ie extends le{constructor(){super("ExceptionObjectNotExist")}}!function(e){e.ExceptionObjectNotExist_Direct=class extends r{get __ex_id(){return this.buffer.dv.getUint32(this.offset+0,!0)}set __ex_id(e){this.buffer.dv.setUint32(this.offset+0,e,!0)}}}(we||(we={}));class Ee extends le{constructor(){super("ExceptionUnknownFunctionIndex")}}!function(e){e.ExceptionUnknownFunctionIndex_Direct=class extends r{get __ex_id(){return this.buffer.dv.getUint32(this.offset+0,!0)}set __ex_id(e){this.buffer.dv.setUint32(this.offset+0,e,!0)}}}(we||(we={}));class Oe extends le{constructor(){super("ExceptionUnknownMessageId")}}!function(e){e.ExceptionUnknownMessageId_Direct=class extends r{get __ex_id(){return this.buffer.dv.getUint32(this.offset+0,!0)}set __ex_id(e){this.buffer.dv.setUint32(this.offset+0,e,!0)}}}(we||(we={}));class Ae extends le{constructor(e){super("ExceptionUnsecuredObject"),this.class_id=e}}!function(e){e.ExceptionUnsecuredObject_Direct=class extends r{get __ex_id(){return this.buffer.dv.getUint32(this.offset+0,!0)}set __ex_id(e){this.buffer.dv.setUint32(this.offset+0,e,!0)}get class_id(){const e=this.offset+4,t=this.buffer.dv.getUint32(e+4,!0);return t>0?ve.decode(new DataView(this.buffer.array_buffer,e+this.buffer.dv.getUint32(e,!0),t)):""}set class_id(e){const t=ge.encode(e),s=i(this.buffer,this.offset+4,t.length,1,1);new Uint8Array(this.buffer.array_buffer,s).set(t)}}}(we||(we={}));class Fe extends le{constructor(){super("ExceptionBadAccess")}}!function(e){e.ExceptionBadAccess_Direct=class extends r{get __ex_id(){return this.buffer.dv.getUint32(this.offset+0,!0)}set __ex_id(e){this.buffer.dv.setUint32(this.offset+0,e,!0)}}}(we||(we={}));class Me extends le{constructor(){super("ExceptionBadInput")}}!function(e){e.ExceptionBadInput_Direct=class extends r{get __ex_id(){return this.buffer.dv.getUint32(this.offset+0,!0)}set __ex_id(e){this.buffer.dv.setUint32(this.offset+0,e,!0)}}}(we||(we={})),function(e){e[e.DebugLevel_Critical=0]="DebugLevel_Critical",e[e.DebugLevel_InactiveTimeout=1]="DebugLevel_InactiveTimeout",e[e.DebugLevel_EveryCall=2]="DebugLevel_EveryCall",e[e.DebugLevel_EveryMessageContent=3]="DebugLevel_EveryMessageContent",e[e.DebugLevel_TraceAll=4]="DebugLevel_TraceAll"}(xe||(xe={})),function(e){e[e.Tcp=0]="Tcp",e[e.TcpTethered=1]="TcpTethered",e[e.WebSocket=2]="WebSocket",e[e.SecuredWebSocket=3]="SecuredWebSocket",e[e.SharedMemory=4]="SharedMemory"}(ye||(ye={})),function(e){let t,s;!function(e){e.ObjectIdLocal_Direct=class extends r{get poa_idx(){return this.buffer.dv.getUint16(this.offset+0,!0)}set poa_idx(e){this.buffer.dv.setUint16(this.offset+0,e,!0)}get object_id(){return this.buffer.dv.getBigUint64(this.offset+8,!0)}set object_id(e){this.buffer.dv.setBigUint64(this.offset+8,e,!0)}}}(t=e.Flat_nprpc_base||(e.Flat_nprpc_base={})),function(e){e[e.Persistent=1]="Persistent",e[e.Tethered=2]="Tethered"}(s=e.ObjectFlag||(e.ObjectFlag={})),function(e){e.ObjectId_Direct=class extends r{get object_id(){return this.buffer.dv.getBigUint64(this.offset+0,!0)}set object_id(e){this.buffer.dv.setBigUint64(this.offset+0,e,!0)}get poa_idx(){return this.buffer.dv.getUint16(this.offset+8,!0)}set poa_idx(e){this.buffer.dv.setUint16(this.offset+8,e,!0)}get flags(){return this.buffer.dv.getUint16(this.offset+10,!0)}set flags(e){this.buffer.dv.setUint16(this.offset+10,e,!0)}origin_d(){return new M(this.buffer,this.offset+12,16)}get class_id(){const e=this.offset+28,t=this.buffer.dv.getUint32(e+4,!0);return t>0?ve.decode(new DataView(this.buffer.array_buffer,e+this.buffer.dv.getUint32(e,!0),t)):""}set class_id(e){const t=ge.encode(e),s=i(this.buffer,this.offset+28,t.length,1,1);new Uint8Array(this.buffer.array_buffer,s).set(t)}get urls(){const e=this.offset+36,t=this.buffer.dv.getUint32(e+4,!0);return t>0?ve.decode(new DataView(this.buffer.array_buffer,e+this.buffer.dv.getUint32(e,!0),t)):""}set urls(e){const t=ge.encode(e),s=i(this.buffer,this.offset+36,t.length,1,1);new Uint8Array(this.buffer.array_buffer,s).set(t)}}}(t=e.Flat_nprpc_base||(e.Flat_nprpc_base={}))}(Ue||(Ue={})),function(e){let t,s,i;!function(e){e[e.FunctionCall=0]="FunctionCall",e[e.BlockResponse=1]="BlockResponse",e[e.AddReference=2]="AddReference",e[e.ReleaseObject=3]="ReleaseObject",e[e.Success=4]="Success",e[e.Exception=5]="Exception",e[e.Error_PoaNotExist=6]="Error_PoaNotExist",e[e.Error_ObjectNotExist=7]="Error_ObjectNotExist",e[e.Error_CommFailure=8]="Error_CommFailure",e[e.Error_UnknownFunctionIdx=9]="Error_UnknownFunctionIdx",e[e.Error_UnknownMessageId=10]="Error_UnknownMessageId",e[e.Error_BadAccess=11]="Error_BadAccess",e[e.Error_BadInput=12]="Error_BadInput"}(t=e.MessageId||(e.MessageId={})),function(e){e[e.Request=0]="Request",e[e.Answer=1]="Answer"}(s=e.MessageType||(e.MessageType={})),function(e){e.Header_Direct=class extends r{get size(){return this.buffer.dv.getUint32(this.offset+0,!0)}set size(e){this.buffer.dv.setUint32(this.offset+0,e,!0)}get msg_id(){return this.buffer.dv.getUint32(this.offset+4,!0)}set msg_id(e){this.buffer.dv.setUint32(this.offset+4,e,!0)}get msg_type(){return this.buffer.dv.getUint32(this.offset+8,!0)}set msg_type(e){this.buffer.dv.setUint32(this.offset+8,e,!0)}get request_id(){return this.buffer.dv.getUint32(this.offset+12,!0)}set request_id(e){this.buffer.dv.setUint32(this.offset+12,e,!0)}}}(i=e.Flat_nprpc_base||(e.Flat_nprpc_base={})),function(e){e.CallHeader_Direct=class extends r{get poa_idx(){return this.buffer.dv.getUint16(this.offset+0,!0)}set poa_idx(e){this.buffer.dv.setUint16(this.offset+0,e,!0)}get interface_idx(){return this.buffer.dv.getUint8(this.offset+2)}set interface_idx(e){this.buffer.dv.setUint8(this.offset+2,e)}get function_idx(){return this.buffer.dv.getUint8(this.offset+3)}set function_idx(e){this.buffer.dv.setUint8(this.offset+3,e)}get object_id(){return this.buffer.dv.getBigUint64(this.offset+8,!0)}set object_id(e){this.buffer.dv.setBigUint64(this.offset+8,e,!0)}}}(i=e.Flat_nprpc_base||(e.Flat_nprpc_base={}))}(De||(De={})),function(e){var t;(t=e.helpers||(e.helpers={})).assign_from_flat_ObjectId=e=>{let t={};return t.object_id=e.object_id,t.poa_idx=e.poa_idx,t.flags=e.flags,t.origin=e.origin_d().array,t.class_id=e.class_id,t.urls=e.urls,t},t.assign_from_ts_ObjectId=(e,t)=>{e.object_id=t.object_id,e.poa_idx=t.poa_idx,e.flags=t.flags,e.origin_d().copy_from_ts_array(t.origin),e.class_id=t.class_id,e.urls=t.urls}}(Ue||(Ue={}));const ze=16,Be=0xffffffffffffffffn;let ke,Se={secured:!1,objects:{}},Te=xe.DebugLevel_Critical;class Ve{constructor(e,t,s){this.type=e,this.hostname=t,this.port=s}static to_string(e){switch(e){case ye.WebSocket:return"ws://";case ye.SecuredWebSocket:return"wss://";default:throw new le("Unknown EndPointType")}}static from_string(e){let t;if(e.startsWith("ws://"))t=ye.WebSocket;else{if(!e.startsWith("wss://"))throw new le("Invalid EndPoint string: "+e);t=ye.SecuredWebSocket}let s=e.indexOf("://")+3,r=e.indexOf(":",s);if(r<0)throw new le("Invalid EndPoint string: "+e);let i=e.substring(s,r),n=e.substring(r+1),f=parseInt(n,10);if(isNaN(f)||f<0||f>65535)throw new le("Invalid port in EndPoint string: "+e);return new Ve(t,i,f)}equal(e){return this.type===e.type&&this.hostname===e.hostname&&this.port===e.port}to_string(){return`${Ve.to_string(this.type)}${this.hostname}:${this.port}`}}function qe(e,t,s){for(;;){let r=ke.get_poa(t);if(!r){Je(e,De.MessageId.Error_PoaNotExist),console.log("Bad poa index. "+t);break}let i=r.get_object(s);if(!i){Je(e,De.MessageId.Error_ObjectNotExist),console.log("Object not found. "+s);break}return i}return null}class Ce{async perform_request(e,t){t.write_request_id(e),this.ws.send(t.writable_view)}on_open(){}async send_receive(e,t){const s=this.next_request_id++,r=new pe;if(this.pending_requests.set(s,{buffer:e,promise:r}),this.ws.readyState===WebSocket.OPEN)this.perform_request(s,e);else{const t=this.ws.onopen;this.ws.onopen=r=>{t&&t.call(this.ws,r),this.pending_requests.has(s)&&this.perform_request(s,e)}}return r.$}on_read(e){let t=ue.from_array_buffer(e.data);if(t.read_msg_type()==De.MessageType.Answer){const s=t.read_request_id(),r=this.pending_requests.get(s);r?(r.buffer.set_buffer(e.data),this.pending_requests.delete(s),r.promise.set_promise()):console.warn("Received response for unknown request ID:",s)}else{const e=t.read_request_id();switch(t.read_msg_id()){case De.MessageId.FunctionCall:{let e=new De.Flat_nprpc_base.CallHeader_Direct(t,ze);Te>=xe.DebugLevel_EveryCall&&console.log("FunctionCall. interface_idx: "+e.interface_idx+" , fn_idx: "+e.function_idx+" , poa_idx: "+e.poa_idx+" , oid: "+e.object_id);let s=qe(t,e.poa_idx,e.object_id);s&&s.dispatch(t,this.endpoint,!1);break}case De.MessageId.AddReference:{let e=new Ue.Flat_nprpc_base.ObjectIdLocal_Direct(t,ze);Te>=xe.DebugLevel_EveryCall&&console.log("AddReference. poa_idx: "+e.poa_idx+" , oid: "+e.object_id),qe(t,e.poa_idx,e.object_id)&&Je(t,De.MessageId.Success);break}case De.MessageId.ReleaseObject:new Ue.Flat_nprpc_base.ObjectIdLocal_Direct(t,ze);break;default:Je(t,De.MessageId.Error_UnknownMessageId)}t.write_request_id(e),this.ws.send(t.writable_view)}}on_close(){for(const[e,t]of this.pending_requests)t.promise.set_exception(new Error("Connection closed"));this.pending_requests.clear()}on_error(e){for(const[e,t]of this.pending_requests)t.promise.set_exception(new Error("Connection error"));this.pending_requests.clear()}constructor(e){if(this.endpoint=e,this.pending_requests=new Map,this.next_request_id=1,Se.secured)this.ws=new WebSocket("wss://"+this.endpoint.hostname+":"+this.endpoint.port.toString(10));else{const e=this.endpoint.hostname;this.ws=new WebSocket("ws://"+e+":"+this.endpoint.port.toString(10))}this.ws.binaryType="arraybuffer",this.ws.onopen=this.on_open.bind(this),this.ws.onclose=this.on_close.bind(this),this.ws.onmessage=this.on_read.bind(this),this.ws.onerror=this.on_error.bind(this)}}class Ne{get_connection(e){let t=this.opened_connections_.find((t=>t.endpoint.equal(e)));if(t)return t;let s=new Ce(e);return this.opened_connections_.push(s),s}create_poa(e){let t=new We(this.last_poa_id_++,e);return this.poa_list_.push(t),t}get_poa(e){return e>=this.poa_list_.length||e<0?null:this.poa_list_[e]}async call(e,t,s=2500){return this.get_connection(e).send_receive(t,s)}static async read_host(){let e=await fetch("./host.json");if(!e.ok)throw"read_host error: "+e.statusText;let t=JSON.parse(await e.text(),((e,t)=>"object_id"===e?BigInt(t):t));null==t.secured&&(t.secured=!1),Se.secured=t.secured;for(let e of Object.keys(t.objects))try{(t.objects[e]=new He(t.objects[e])).select_endpoint()}catch(s){console.error("Error creating ObjectProxy for key: "+e,s),delete t.objects[e]}return t}constructor(e){this.last_poa_id_=0,this.opened_connections_=new Array,this.poa_list_=new Array,e=this.host_info=e}}const Pe=e=>Number(0xffffffffn&e),Re=e=>Number(e>>32n);class Le{add(e){let t=this.tail_idx_;if(t==this.max_size_)return Be;let s=this.data_[this.tail_idx_];return this.tail_idx_=Pe(s.oid),s.obj=e,BigInt(t)|BigInt(Re(s.oid))<<32n}remove(e){let t=Pe(e);this.data_[t].oid=BigInt(this.tail_idx_)|BigInt(Re(e)+1),this.data_[t].obj=null,this.tail_idx_=t}get(e){let t=Pe(e);if(t>=this.max_size_)return null;let s=this.data_[t];return Re(s.oid)!=Re(e)?null:s.obj}constructor(e){this.max_size_=e,this.data_=new Array(this.max_size_);for(let e=0;e<this.max_size_;++e)this.data_[e]={oid:BigInt(e+1),obj:null};Object.seal(this.data_),this.tail_idx_=0}}class We{get index(){return this.index_}get_object(e){return this.object_map_.get(e)}activate_object(e){e.poa_=this,e.activation_time_=Date.now();let t=this.object_map_.add(e);if(t===Be)throw new le("Poa fixed size has been exceeded");return e.object_id_=t,e.ref_cnt_=0,{object_id:t,poa_idx:this.index,flags:Ue.ObjectFlag.Tethered,origin:new Array(16).fill(0),class_id:e.get_class(),urls:""}}deactivate_object(e){}constructor(e,t){this.index_=e,this.object_map_=new Le(t)}}class He{constructor(e){this.data=e||{},this.timeout_ms_=1e3,this.local_ref_cnt_=0}get endpoint(){return void 0!==this.endpoint_||this.select_endpoint(),this.endpoint_}get timeout(){return this.timeout_ms_}add_ref(){if(this.local_ref_cnt_++,1!=this.local_ref_cnt_)return this.local_ref_cnt_;let e=ue.create(32);e.write_len(28),e.write_msg_id(De.MessageId.AddReference),e.write_msg_type(De.MessageType.Request);let t=new Ue.Flat_nprpc_base.ObjectIdLocal_Direct(e,ze);return t.poa_idx=this.data.poa_idx,t.object_id=this.data.object_id,e.commit(32),ke.call(this.endpoint,e,this.timeout).then().catch(),this.local_ref_cnt_}release(){if(0!=--this.local_ref_cnt_)return this.local_ref_cnt_;let e=ue.create(32);e.write_len(28),e.write_msg_id(De.MessageId.ReleaseObject),e.write_msg_type(De.MessageType.Request);let t=new Ue.Flat_nprpc_base.ObjectIdLocal_Direct(e,ze);return t.poa_idx=this.data.poa_idx,t.object_id=this.data.object_id,e.commit(32),ke.call(this.endpoint,e,this.timeout).then().catch(),0}select_endpoint(e){const t=this.data.urls.split(";");if(Se.secured){const e=t.find((e=>e.startsWith("wss://")));if(!e)throw new le("Object has no urls for secured connection");this.endpoint_=Ve.from_string(e)}else{const e=t.find((e=>e.startsWith("ws://")));if(!e)throw new le("Object has no urls for unsecured connection");this.endpoint_=Ve.from_string(e)}e&&("localhost"!==this.endpoint_.hostname&&"127.0.0.1"!==this.endpoint_.hostname||(this.endpoint_.hostname=e.hostname))}}class $e{get poa(){return this.poa_}get oid(){return this.object_id_}add_ref(){return++this.ref_cnt_}constructor(){this.ref_cnt_=0}}const Je=(e,t)=>{e.consume(e.size),e.prepare(ze),e.write_len(12),e.write_msg_id(t),e.write_msg_type(De.MessageType.Answer),e.commit(ze)};class Ge{add_ref(e){this.refs.push({object_id:{poa_idx:e.poa.index,object_id:e.oid},obj:e}),e.add_ref()}remove_ref(e,t){return!1}constructor(){this.refs=new Array}}const Ke=e=>{switch(e.read_msg_id()){case De.MessageId.Success:return 0;case De.MessageId.Exception:return 1;case De.MessageId.Error_ObjectNotExist:throw new Ie;case De.MessageId.Error_CommFailure:let t=new we.ExceptionCommFailure_Direct(e,16);throw new me(t.what);case De.MessageId.Error_UnknownFunctionIdx:throw new Ee;case De.MessageId.Error_UnknownMessageId:throw new Oe;case De.MessageId.Error_BadAccess:throw new Fe;default:return-1}},Qe=Ue.helpers.assign_from_flat_ObjectId,Xe=Ue.helpers.assign_from_ts_ObjectId,Ye=(e,t)=>{if(e.data.class_id!==t.servant_t._get_class())return console.warn("fail: narrowing from "+e.data.class_id+" to "+t.servant_t._get_class()),null;let s=new t;return s.data=e.data,s.local_ref_cnt_=e.local_ref_cnt_,s.timeout_ms_=e.timeout_ms_,e.data=null,e.local_ref_cnt_=0,s},Ze=(e,t)=>{if(e.object_id==Be)return null;const s=new He(Ue.helpers.assign_from_flat_ObjectId(e));return e.flags&Ue.ObjectFlag.Tethered?(s.data.urls=t.to_string(),s.endpoint_=t):s.select_endpoint(t),s},et=async(e=!0)=>ke||(ke=new Ne(e?await Ne.read_host():{})),tt=e=>{Te=e},st=new TextEncoder,rt=new TextDecoder;class it extends He{static get servant_t(){return nt}async Bind(e,t){let s=2==arguments.length?0:arguments[arguments.length-1],r=ue.create();r.prepare(216),r.commit(88),r.write_msg_id(De.MessageId.FunctionCall),r.write_msg_type(De.MessageType.Request);let i=new De.Flat_nprpc_base.CallHeader_Direct(r,16);i.object_id=this.data.object_id,i.poa_idx=this.data.poa_idx,i.interface_idx=s,i.function_idx=0;let n=new ft.nprpc_nameserver_M1_Direct(r,32);Xe(n._1,e),n._2=t,r.write_len(r.size-4),await ke.call(this.endpoint,r,this.timeout),0!=Ke(r)&&console.log("received an unusual reply for function with no output arguments")}async Resolve(e,t){let s=2==arguments.length?0:arguments[arguments.length-1],r=ue.create();r.prepare(168),r.commit(40),r.write_msg_id(De.MessageId.FunctionCall),r.write_msg_type(De.MessageType.Request);let i=new De.Flat_nprpc_base.CallHeader_Direct(r,16);if(i.object_id=this.data.object_id,i.poa_idx=this.data.poa_idx,i.interface_idx=s,i.function_idx=1,new ft.nprpc_nameserver_M2_Direct(r,32)._1=e,r.write_len(r.size-4),await ke.call(this.endpoint,r,this.timeout),-1!=Ke(r))throw console.log("received an unusual reply for function with output arguments"),new le("Unknown Error");let n,f=new ft.nprpc_nameserver_M3_Direct(r,16);return t.value=Ze(f._2,this.endpoint),n=f._1,n}}class nt extends $e{constructor(){super(...arguments),this.get_class=()=>nt._get_class(),this.dispatch=(e,t,s)=>{nt._dispatch(this,e,t,s)}}static _get_class(){return"nprpc_nameserver/nprpc.Nameserver"}static _dispatch(e,t,s,r){switch(new De.Flat_nprpc_base.CallHeader_Direct(t,16).function_idx){case 0:{let r=new ft.nprpc_nameserver_M1_Direct(t,32);e.Bind(Ze(r._1,s),r._2),Je(t,De.MessageId.Success);break}case 1:{let s=new ft.nprpc_nameserver_M2_Direct(t,32),r=t;r.consume(r.size),r.prepare(200),r.commit(72);let i,n=new ft.nprpc_nameserver_M3_Direct(r,16);i=e.Resolve(s._1,n._2),n._1=i,r.write_len(r.size-4),r.write_msg_id(De.MessageId.BlockResponse),r.write_msg_type(De.MessageType.Answer);break}default:Je(t,De.MessageId.Error_UnknownFunctionIdx)}}}var ft;function ot(e){const t={object_id:0n,poa_idx:0,flags:Ue.ObjectFlag.Persistent,origin:new Array(16).fill(0),class_id:nt._get_class(),urls:"ws://"+e+":15001"},s=new it(t);return s.select_endpoint(),s}return function(e){e.nprpc_nameserver_M1_Direct=class extends r{get _1(){return new Ue.Flat_nprpc_base.ObjectId_Direct(this.buffer,this.offset+0)}get _2(){const e=this.offset+48,t=this.buffer.dv.getUint32(e+4,!0);return t>0?rt.decode(new DataView(this.buffer.array_buffer,e+this.buffer.dv.getUint32(e,!0),t)):""}set _2(e){const t=st.encode(e),s=i(this.buffer,this.offset+48,t.length,1,1);new Uint8Array(this.buffer.array_buffer,s).set(t)}}}(ft||(ft={})),function(e){e.nprpc_nameserver_M2_Direct=class extends r{get _1(){const e=this.offset+0,t=this.buffer.dv.getUint32(e+4,!0);return t>0?rt.decode(new DataView(this.buffer.array_buffer,e+this.buffer.dv.getUint32(e,!0),t)):""}set _1(e){const t=st.encode(e),s=i(this.buffer,this.offset+0,t.length,1,1);new Uint8Array(this.buffer.array_buffer,s).set(t)}}}(ft||(ft={})),function(e){e.nprpc_nameserver_M3_Direct=class extends r{get _1(){return 1===this.buffer.dv.getUint8(this.offset+0)}set _1(e){this.buffer.dv.setUint8(this.offset+0,!0===e?1:0)}get _2(){return new Ue.Flat_nprpc_base.ObjectId_Direct(this.buffer,this.offset+8)}}}(ft||(ft={})),t})()));